<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.toon_rt_solver &mdash; BioSNICAR 2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> BioSNICAR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../theoretical-background.html">Theoretical Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how-to-use.html">How to Use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../inputs.html">Input Configuration Guide for BioSNICAR</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">BioSNICAR Functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">BioSNICAR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>src.toon_rt_solver</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.toon_rt_solver</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;./src&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="kn">from</span> <span class="nn">setup_snicar</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">classes</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="toon_solver"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.toon_solver">[docs]</a><span class="k">def</span> <span class="nf">toon_solver</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">ssa</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">L_snw</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">rt_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Driver func for toon radiative transfer solver.</span>

<span class="sd">    Makes function calls relating to radiative transfer solver in sequence and returns outputs.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        tau: optical thickness</span>
<span class="sd">        ssa: single scattering albedo</span>
<span class="sd">        g: asymmetry parameter</span>
<span class="sd">        L_snw: mass of ice in each layer</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        rt_config: instance of RTConfig class</span>

<span class="sd">    Returns:</span>
<span class="sd">        outputs: instance of Outputs class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validate_inputs_toon</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">)</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># PERFORM DELTA TRANSFORMATION IF REQUIRED</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># The star represents the delta transformed quantity</span>
    <span class="c1"># if no delta transformation is applied, the starred quantity</span>
    <span class="c1"># is equal to the unstarred quantity</span>

    <span class="n">g_star</span><span class="p">,</span> <span class="n">ssa_star</span><span class="p">,</span> <span class="n">tau_star</span> <span class="o">=</span> <span class="n">delta_transformation</span><span class="p">(</span><span class="n">rt_config</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">ssa</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>

    <span class="c1"># CALCULATE TOTAL OPTICAL DEPTH OF ENTIRE COLUMN</span>
    <span class="c1"># i.e. tau_clm = total optical depth from upper boundary</span>
    <span class="c1"># to upper boundary of layer n. This is therefore a cumulative</span>
    <span class="c1"># quantity - subsequently lower layers contain the sum of the</span>
    <span class="c1"># # optical depth of all overlying layers</span>

    <span class="n">tau_clm</span> <span class="o">=</span> <span class="n">calculate_optical_depth_of_column</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">)</span>

    <span class="c1"># SET BOUNDARY CONDITION: BOTTOM BOUNDARY</span>
    <span class="c1"># calculate radiation reflected skywards by underlying surface</span>
    <span class="c1"># (i.e. lower model boundary)</span>
    <span class="c1"># remainder is lost</span>

    <span class="n">s_sfc</span> <span class="o">=</span> <span class="n">boundary_condition</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">,</span> <span class="n">tau_clm</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># Apply Two-Stream Approximation (Toon et al, table 1)</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">,</span> <span class="n">gamma3</span><span class="p">,</span> <span class="n">gamma4</span><span class="p">,</span> <span class="n">mu_one</span> <span class="o">=</span> <span class="n">two_stream_approximation</span><span class="p">(</span>
        <span class="n">rt_config</span><span class="p">,</span> <span class="n">ssa_star</span><span class="p">,</span> <span class="n">g_star</span><span class="p">,</span> <span class="n">illumination</span>
    <span class="p">)</span>

    <span class="c1"># Toon et al equation 21 and 22</span>
    <span class="c1"># Note that the values of lam and GAMMA depend upon gamma1 and gamma2, which</span>
    <span class="c1"># vary depending upon the two-stream approximation used</span>
    <span class="c1"># variable &quot;lambda&quot; renamed &quot;lam&quot; to avoid confusion with lambda function</span>
    <span class="n">lam</span><span class="p">,</span> <span class="n">GAMMA</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">,</span> <span class="n">e4</span> <span class="o">=</span> <span class="n">calculate_matrix_coefficients</span><span class="p">(</span><span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># Calculate C-functions</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>

    <span class="c1"># C is the direct beam flux calculated at the top and bottom of each layer, i,</span>
    <span class="c1"># see Toon equations 23 and 24</span>
    <span class="n">C_pls_btm</span><span class="p">,</span> <span class="n">C_mns_btm</span><span class="p">,</span> <span class="n">C_pls_top</span><span class="p">,</span> <span class="n">C_mns_top</span> <span class="o">=</span> <span class="n">c_functions</span><span class="p">(</span>
        <span class="n">ice</span><span class="p">,</span>
        <span class="n">model_config</span><span class="p">,</span>
        <span class="n">illumination</span><span class="p">,</span>
        <span class="n">ssa_star</span><span class="p">,</span>
        <span class="n">tau_star</span><span class="p">,</span>
        <span class="n">tau_clm</span><span class="p">,</span>
        <span class="n">lam</span><span class="p">,</span>
        <span class="n">gamma1</span><span class="p">,</span>
        <span class="n">gamma2</span><span class="p">,</span>
        <span class="n">gamma3</span><span class="p">,</span>
        <span class="n">gamma4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># Initialize tridiagonal matrix solution</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>

    <span class="c1"># expanding the number of layers to 2*ice.nbr_lyr so that fluxes at upper and lower</span>
    <span class="c1"># layer boundaries can be resolved. This section was confusing to code -</span>
    <span class="c1"># for each layer</span>
    <span class="c1"># index (n) a second pair of indices (2 x i) are required. Different solutions are</span>
    <span class="c1"># applied depending upon whether i is even or odd. To translate the indexing for</span>
    <span class="c1"># this from FORTRAN/MATLAB into Python, it was necessary to assert n = (i/2)-1</span>
    <span class="c1"># for even layers and n = floor(i/2) for odd layers, with specific rules for the</span>
    <span class="c1"># boundaries i = 0 and i = ice.nbr_lyrs-1 (i.e. top surface and bottom surface).</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">matrix_solver</span><span class="p">(</span>
        <span class="n">ice</span><span class="p">,</span>
        <span class="n">illumination</span><span class="p">,</span>
        <span class="n">model_config</span><span class="p">,</span>
        <span class="n">s_sfc</span><span class="p">,</span>
        <span class="n">C_pls_btm</span><span class="p">,</span>
        <span class="n">C_mns_btm</span><span class="p">,</span>
        <span class="n">C_pls_top</span><span class="p">,</span>
        <span class="n">C_mns_top</span><span class="p">,</span>
        <span class="n">e1</span><span class="p">,</span>
        <span class="n">e2</span><span class="p">,</span>
        <span class="n">e3</span><span class="p">,</span>
        <span class="n">e4</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">F_net</span><span class="p">,</span> <span class="n">F_top_pls</span><span class="p">,</span> <span class="n">F_btm_net</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">,</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">layer_fluxes</span><span class="p">(</span>
        <span class="n">ice</span><span class="p">,</span>
        <span class="n">illumination</span><span class="p">,</span>
        <span class="n">model_config</span><span class="p">,</span>
        <span class="n">tau_clm</span><span class="p">,</span>
        <span class="n">tau_star</span><span class="p">,</span>
        <span class="n">lam</span><span class="p">,</span>
        <span class="n">Y</span><span class="p">,</span>
        <span class="n">GAMMA</span><span class="p">,</span>
        <span class="n">C_pls_btm</span><span class="p">,</span>
        <span class="n">C_mns_btm</span><span class="p">,</span>
        <span class="n">C_pls_top</span><span class="p">,</span>
        <span class="n">C_mns_top</span><span class="p">,</span>
        <span class="n">e1</span><span class="p">,</span>
        <span class="n">e2</span><span class="p">,</span>
        <span class="n">e3</span><span class="p">,</span>
        <span class="n">e4</span><span class="p">,</span>
        <span class="n">mu_one</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">F_abs</span> <span class="o">=</span> <span class="n">absorbed_fluxes</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">F_net</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">)</span>
    <span class="c1"># Energy conservation check:</span>
    <span class="c1"># % Incident direct + diffuse radiation equals(absorbed + transmitted +</span>
    <span class="c1"># bulk_reflected)</span>
    <span class="c1"># conservation_of_energy_check(illumination, F_abs, F_btm_net, F_top_pls)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">get_outputs</span><span class="p">(</span>
        <span class="n">model_config</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">,</span> <span class="n">F_top_pls</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">,</span> <span class="n">F_btm_net</span><span class="p">,</span> <span class="n">F_abs</span><span class="p">,</span> <span class="n">L_snw</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">model_config</span><span class="o">.</span><span class="n">smooth</span><span class="p">:</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">albedo</span> <span class="o">=</span> <span class="n">apply_smoothing_function</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">albedo</span><span class="p">,</span> <span class="n">model_config</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outputs</span></div>


<div class="viewcode-block" id="validate_inputs_toon"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.validate_inputs_toon">[docs]</a><span class="k">def</span> <span class="nf">validate_inputs_toon</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Checks input parameters are valid for Toon solver.</span>

<span class="sd">    Checks for known invalid data configurations that break the Toon solver.</span>
<span class="sd">    If invalid config is detected a ValueError is raised, halting execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: class representing the ice column and containing related physical constants</span>
<span class="sd">        illumination: class representing incoming irradiance containing related physical constants</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: raised with descriptive error message if invalid input detected</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">layer_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are solid ice layers in this model - use AD solver&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">solzen</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">solzen</span> <span class="o">&gt;</span> <span class="mi">89</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zenith angle out of valid range for Toon solver&quot;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">cdom</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cdom is only available for solid ice layers&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="delta_transformation"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.delta_transformation">[docs]</a><span class="k">def</span> <span class="nf">delta_transformation</span><span class="p">(</span><span class="n">rt_config</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">ssa</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applied Delta transformation.</span>

<span class="sd">    Args:</span>
<span class="sd">        rt_config: instance of RTConfig class</span>
<span class="sd">        g: asymmetry parameter</span>
<span class="sd">        ssa: single scatterign albedo</span>
<span class="sd">        tau: optical thickness</span>

<span class="sd">    Returns:</span>
<span class="sd">        g_star: delta scaled asymmetry parameter</span>
<span class="sd">        ssa_star: delta scaled singloe scattering albedo</span>
<span class="sd">        tau_star: delta scaled optical thickness</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rt_config</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>

        <span class="n">g_star</span> <span class="o">=</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span>
        <span class="n">ssa_star</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">ssa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">tau_star</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">tau</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">g_star</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">ssa_star</span> <span class="o">=</span> <span class="n">ssa</span>
        <span class="n">tau_star</span> <span class="o">=</span> <span class="n">tau</span>

    <span class="k">return</span> <span class="n">g_star</span><span class="p">,</span> <span class="n">ssa_star</span><span class="p">,</span> <span class="n">tau_star</span></div>


<div class="viewcode-block" id="calculate_optical_depth_of_column"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.calculate_optical_depth_of_column">[docs]</a><span class="k">def</span> <span class="nf">calculate_optical_depth_of_column</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates colum,n optical thickness.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class </span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        tau_star: delta scaled optical thickness</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        tau_clm: optical thickness of column</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tau_clm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># start loop from 2nd layer, i.e. index = 1</span>
        <span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">tau_clm</span></div>


<div class="viewcode-block" id="boundary_condition"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.boundary_condition">[docs]</a><span class="k">def</span> <span class="nf">boundary_condition</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">,</span> <span class="n">tau_clm</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates reflectance from underlying surface.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        tau_clm: optical thickness of column</span>
<span class="sd">        tau_star: delta_scaled optical thickness</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        S_sfc: reflectance from underlying surface</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s_sfc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ice</span><span class="o">.</span><span class="n">sfc</span>
        <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="o">-</span><span class="p">(</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span>
        <span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">s_sfc</span></div>


<div class="viewcode-block" id="two_stream_approximation"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.two_stream_approximation">[docs]</a><span class="k">def</span> <span class="nf">two_stream_approximation</span><span class="p">(</span><span class="n">rt_config</span><span class="p">,</span> <span class="n">ssa_star</span><span class="p">,</span> <span class="n">g_star</span><span class="p">,</span> <span class="n">illumination</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies two-stream approximation.</span>

<span class="sd">    Three 2-stream approximations are available: Eddington,</span>
<span class="sd">    Quadrature and hemispheric mean. The equations for each</span>
<span class="sd">    approximation are provided in Toon et al. (1989) Table 1.</span>

<span class="sd">    The hemispheric mean scheme is derived by assuming that the</span>
<span class="sd">    phase function is equal to 1  + g  in the forward scattering</span>
<span class="sd">    hemisphere and to 1  - g  in the backward scattering hemisphere.</span>
<span class="sd">    The asymmetry parameter is g. The hemispheric mean is only</span>
<span class="sd">    useful for infrared wavelengths.</span>

<span class="sd">    Args:</span>
<span class="sd">        rt_config: instance of RTConfig class</span>
<span class="sd">        ssa_star: delta scaled signle scattering albedo</span>
<span class="sd">        g_star: delta scaled asymmetry parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        gamma1: coefficient for matrix solution</span>
<span class="sd">        gamma2: coefficient for matrix solution</span>
<span class="sd">        gamma3: coefficient for matrix solution</span>
<span class="sd">        gamma4: coefficient for matrix solution</span>
<span class="sd">        mu_one: adjusted incidence angle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rt_config</span><span class="o">.</span><span class="n">aprx_typ</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># apply Eddington approximation</span>
        <span class="n">gamma1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa_star</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">g_star</span><span class="p">))))</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">gamma2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa_star</span> <span class="o">*</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">g_star</span><span class="p">))))</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">gamma3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">g_star</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="n">gamma4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gamma3</span>
        <span class="n">mu_one</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">elif</span> <span class="n">rt_config</span><span class="o">.</span><span class="n">aprx_typ</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># apply quadrature approximation</span>
        <span class="n">gamma1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa_star</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g_star</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">gamma2</span> <span class="o">=</span> <span class="n">ssa_star</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">g_star</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">gamma3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">g_star</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">gamma4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gamma3</span>
        <span class="n">mu_one</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">rt_config</span><span class="o">.</span><span class="n">aprx_typ</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># apply hemispheric mean approximation</span>
        <span class="n">gamma1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">ssa_star</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g_star</span><span class="p">))</span>
        <span class="n">gamma2</span> <span class="o">=</span> <span class="n">ssa_star</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">g_star</span><span class="p">)</span>
        <span class="n">gamma3</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">g_star</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">gamma4</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">gamma3</span>
        <span class="n">mu_one</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="k">return</span> <span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">,</span> <span class="n">gamma3</span><span class="p">,</span> <span class="n">gamma4</span><span class="p">,</span> <span class="n">mu_one</span></div>


<div class="viewcode-block" id="calculate_matrix_coefficients"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.calculate_matrix_coefficients">[docs]</a><span class="k">def</span> <span class="nf">calculate_matrix_coefficients</span><span class="p">(</span><span class="n">gamma1</span><span class="p">,</span> <span class="n">gamma2</span><span class="p">,</span> <span class="n">tau_star</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;calculates coefficients required for matrix calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        gamma1: coefficient for matrix solution</span>
<span class="sd">        gamma2: coefficient for matrix solution</span>
<span class="sd">        tau_star: delta scaled optical thickness</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        lam: coefficient for matrix solution</span>
<span class="sd">        GAMMA: coefficient for matrix solution</span>
<span class="sd">        e1: coefficient for matrix solution</span>
<span class="sd">        e2: coefficient for matrix solution</span>
<span class="sd">        e3: coefficient for matrix solution</span>
<span class="sd">        e4: coefficient for matrix solution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">gamma1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">gamma2</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="n">GAMMA</span> <span class="o">=</span> <span class="n">gamma2</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma1</span> <span class="o">+</span> <span class="n">lam</span><span class="p">)</span>

    <span class="c1"># calculate coefficients required for tridiagonal matrix calculation</span>
    <span class="c1"># (Toon et al Equation 44)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">GAMMA</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">))</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">GAMMA</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">))</span>
    <span class="n">e3</span> <span class="o">=</span> <span class="n">GAMMA</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">)</span>
    <span class="n">e4</span> <span class="o">=</span> <span class="n">GAMMA</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lam</span><span class="p">,</span> <span class="n">GAMMA</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">,</span> <span class="n">e4</span></div>


<div class="viewcode-block" id="c_functions"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.c_functions">[docs]</a><span class="k">def</span> <span class="nf">c_functions</span><span class="p">(</span>
    <span class="n">ice</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">illumination</span><span class="p">,</span>
    <span class="n">ssa_star</span><span class="p">,</span>
    <span class="n">tau_star</span><span class="p">,</span>
    <span class="n">tau_clm</span><span class="p">,</span>
    <span class="n">lam</span><span class="p">,</span>
    <span class="n">gamma1</span><span class="p">,</span>
    <span class="n">gamma2</span><span class="p">,</span>
    <span class="n">gamma3</span><span class="p">,</span>
    <span class="n">gamma4</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate fluxes through column.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        ssa_star: delta scaled single scatterign albedo</span>
<span class="sd">        tau_star: delta scaled optical thickness</span>
<span class="sd">        tau_clm: column optical thickness</span>
<span class="sd">        lam: coefficient for matrix solution</span>
<span class="sd">        gamma1: coefficient for matrix solution</span>
<span class="sd">        gamma2: coefficient for matrix solution</span>
<span class="sd">        gamma3: coefficient for matrix solution</span>
<span class="sd">        gamma4: coefficient for matrix solution</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        C_pls_btm: upwards flux from bottom of layer</span>
<span class="sd">        C_mns_btm: downwards flux from bottom of layer</span>
<span class="sd">        C_pls_top: upwards flux from top of layer</span>
<span class="sd">        C_mns_top: downwards flux from top of layer</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">C_pls_btm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">C_mns_btm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">C_pls_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">C_mns_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>

            <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ssa_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">gamma1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">gamma4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">gamma2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

            <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ssa_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">((</span><span class="n">gamma1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">gamma2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">gamma3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">C_pls_top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ssa_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">gamma1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">gamma4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">gamma2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">lam</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">C_mns_top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ssa_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">gamma1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="o">+</span> <span class="p">(</span><span class="n">gamma2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">gamma3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no direct-beam flux:</span>
            <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">C_pls_top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">C_mns_top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">C_pls_btm</span><span class="p">,</span> <span class="n">C_mns_btm</span><span class="p">,</span> <span class="n">C_pls_top</span><span class="p">,</span> <span class="n">C_mns_top</span></div>


<div class="viewcode-block" id="matrix_solver"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.matrix_solver">[docs]</a><span class="k">def</span> <span class="nf">matrix_solver</span><span class="p">(</span>
    <span class="n">ice</span><span class="p">,</span>
    <span class="n">illumination</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">s_sfc</span><span class="p">,</span>
    <span class="n">C_pls_btm</span><span class="p">,</span>
    <span class="n">C_mns_btm</span><span class="p">,</span>
    <span class="n">C_pls_top</span><span class="p">,</span>
    <span class="n">C_mns_top</span><span class="p">,</span>
    <span class="n">e1</span><span class="p">,</span>
    <span class="n">e2</span><span class="p">,</span>
    <span class="n">e3</span><span class="p">,</span>
    <span class="n">e4</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute matrix calculation.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        s_sfc: reflectance of underlying surface</span>
<span class="sd">        C_pls_btm: upwards flux from bottom of layer</span>
<span class="sd">        C_mns_btm: downwards flux from bottom of layer</span>
<span class="sd">        C_pls_top: upwards flux from top of layer</span>
<span class="sd">        C_mns_top: downwards flux from top of layer</span>
<span class="sd">        e1: coefficient for matrix solution</span>
<span class="sd">        e2: coefficient for matrix solution</span>
<span class="sd">        e3: coefficient for matrix solution</span>
<span class="sd">        e4: coefficient for matrix solution</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Y: intermediate representing t-0boundary fluxes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Toon equations 41-43.</span>
    <span class="c1"># Boundary values for i=1 and i=2 * nbr_lyr, specifics for i=odd and i=even</span>
    <span class="c1"># Set up lists</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

        <span class="c1"># TOP LAYER</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">e2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">E</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span> <span class="o">-</span> <span class="n">C_mns_top</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># BOTTOM LAYER</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">sfc</span> <span class="o">*</span> <span class="n">e3</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">e2</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">sfc</span> <span class="o">*</span> <span class="n">e4</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">s_sfc</span><span class="p">[:]</span>
                <span class="o">-</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">sfc</span> <span class="o">*</span> <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="p">)</span>

        <span class="c1"># EVEN NUMBERED LAYERS</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e3</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e4</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e3</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e3</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e3</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e4</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e2</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e3</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_pls_top</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">e1</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_mns_btm</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">C_mns_top</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="p">)</span>

        <span class="c1"># ODD NUMBERED LAYERS</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e3</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e4</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e2</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e4</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e4</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e4</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e3</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_pls_top</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">+</span> <span class="p">(</span>
                <span class="n">e4</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C_mns_top</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:])</span>
            <span class="p">)</span>

    <span class="c1"># Now the actual tridiagonal matrix solving. Simply dividing A/B and E/B</span>
    <span class="c1"># throws an exception due to division by zero. Here we use numpy&#39;s nan_to_num</span>
    <span class="c1"># function to achieve the division where possible and replace nans with zeros.</span>
    <span class="c1"># We also set numpy to ignore the division error.</span>

    <span class="c1"># for bottom layer only</span>
    <span class="c1"># Toon et al Eq 45</span>
    <span class="n">AS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">DS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">AS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="p">)</span>
    <span class="n">DS</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span>
        <span class="n">E</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">B</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="p">)</span>

    <span class="c1"># for all layers above bottom layer, starting at second-to-bottom and</span>
    <span class="c1"># progressing towards surface:</span>
    <span class="c1"># Toon et al Eq 46</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">AS</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="n">AS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">DS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">((</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">DS</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">*</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

    <span class="c1"># then for all layers, progressing from surface to bottom</span>
    <span class="c1"># Toon et al Eq 47</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">DS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">AS</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

    <span class="k">return</span> <span class="n">Y</span></div>


<div class="viewcode-block" id="layer_fluxes"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.layer_fluxes">[docs]</a><span class="k">def</span> <span class="nf">layer_fluxes</span><span class="p">(</span>
    <span class="n">ice</span><span class="p">,</span>
    <span class="n">illumination</span><span class="p">,</span>
    <span class="n">model_config</span><span class="p">,</span>
    <span class="n">tau_clm</span><span class="p">,</span>
    <span class="n">tau_star</span><span class="p">,</span>
    <span class="n">lam</span><span class="p">,</span>
    <span class="n">Y</span><span class="p">,</span>
    <span class="n">GAMMA</span><span class="p">,</span>
    <span class="n">C_pls_btm</span><span class="p">,</span>
    <span class="n">C_mns_btm</span><span class="p">,</span>
    <span class="n">C_pls_top</span><span class="p">,</span>
    <span class="n">C_mns_top</span><span class="p">,</span>
    <span class="n">e1</span><span class="p">,</span>
    <span class="n">e2</span><span class="p">,</span>
    <span class="n">e3</span><span class="p">,</span>
    <span class="n">e4</span><span class="p">,</span>
    <span class="n">mu_one</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate total fluxes.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        tau_clm: optical thickness of column</span>
<span class="sd">        lam: intermediate coefficient</span>
<span class="sd">        GAMMA: intermediate coefficient</span>
<span class="sd">        tau_star: delta scaled optical thickness</span>
<span class="sd">        C_pls_btm: upwards flux from bottom of layer</span>
<span class="sd">        C_mns_btm: downwards flux from bottom of layer</span>
<span class="sd">        C_pls_top: upwards flux from top of layer</span>
<span class="sd">        C_mns_top: downwards flux from top of layer</span>
<span class="sd">        e1: coefficient for matrix solution</span>
<span class="sd">        e2: coefficient for matrix solution</span>
<span class="sd">        e3: coefficient for matrix solution</span>
<span class="sd">        e4: coefficient for matrix solution</span>
<span class="sd">        mu_one: adjusted indicence angle</span>

<span class="sd">    Returns:</span>
<span class="sd">        F_net: net flux in each layer</span>
<span class="sd">        F_top_pls: net upwards flux from upper surface of each layer</span>
<span class="sd">        F_btm_net: net flux at bottom surface</span>
<span class="sd">        F_top_net: net fluxes at upper surface</span>
<span class="sd">        intensity: mean intensity at base of each layer</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_net</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_btm_net</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_top_net</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_top_pls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="n">F_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># CALCULATE DIRECT BEAM FLUX AT BOTTOM OF EACH LAYER</span>

    <span class="c1"># loop through layers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

        <span class="c1"># (Toon et al. eq 50)</span>
        <span class="n">direct</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">tau_clm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># net flux (positive upward = F_up - F_down) at the base of each layer</span>
        <span class="c1"># (Toon et al. Eq 48)</span>
        <span class="n">F_net</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">e3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">e4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">-</span> <span class="n">direct</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span>

        <span class="c1"># mean intensity at the base of each layer (Toon et al. Eq 49)</span>
        <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">mu_one</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">e3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="o">+</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">e4</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="o">+</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">+</span> <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">direct</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span><span class="p">)</span>
        <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># Upward flux at upper model boundary (Toon et al Eq 31)</span>
    <span class="n">F_top_pls</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="n">GAMMA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">GAMMA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="o">+</span> <span class="n">C_pls_top</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

        <span class="c1"># Upward flux at the bottom of each layer interface (Toon et al. Eq31)</span>
        <span class="n">F_up</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">GAMMA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">GAMMA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="n">C_pls_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span>

        <span class="c1"># Downward flux at the bottom of each layer interface (Toon et al. Eq32)</span>
        <span class="c1"># plus direct beam component</span>
        <span class="n">F_down</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">GAMMA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="n">Y</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">GAMMA</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lam</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">tau_star</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">+</span> <span class="n">C_mns_btm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="o">+</span> <span class="n">direct</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span>

    <span class="c1"># Net flux at lower model boundary = bulk transmission through entire media</span>
    <span class="c1"># = energy absorbed by underlying surface</span>
    <span class="n">F_btm_net</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">F_net</span><span class="p">[</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">F_net</span><span class="p">,</span> <span class="n">F_top_pls</span><span class="p">,</span> <span class="n">F_btm_net</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">,</span> <span class="n">intensity</span></div>


<div class="viewcode-block" id="absorbed_fluxes"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.absorbed_fluxes">[docs]</a><span class="k">def</span> <span class="nf">absorbed_fluxes</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">model_config</span><span class="p">,</span> <span class="n">F_net</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates energy absorbed in each layer.</span>

<span class="sd">    Args:</span>
<span class="sd">        ice: instance of Ice class</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        F_net: net flux in each layer</span>
<span class="sd">        F_top_net: net flux at upper model boundary</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        F_abs: absorbed flux in each layer</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">F_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">])</span>
    <span class="c1"># absorbed flux in each layer (negative if there is net emission (bnd_typ = 4))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">F_abs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F_net</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">F_top_net</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">F_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F_net</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">F_net</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">F_abs</span></div>


<div class="viewcode-block" id="conservation_of_energy_check"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.conservation_of_energy_check">[docs]</a><span class="k">def</span> <span class="nf">conservation_of_energy_check</span><span class="p">(</span><span class="n">illumination</span><span class="p">,</span> <span class="n">F_abs</span><span class="p">,</span> <span class="n">F_btm_net</span><span class="p">,</span> <span class="n">F_top_pls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks there is no conservation of energy violation.</span>

<span class="sd">    Args:</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        F_abs: absorbed flux in each layer</span>
<span class="sd">        F_btm_net: net flux at bottom surface</span>
<span class="sd">        F_top_pls: upwards flux from upper boundary</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError is conservation of energy error is detected</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">energy_sum</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span>
        <span class="o">-</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">F_abs</span><span class="p">)</span> <span class="o">+</span> <span class="n">F_btm_net</span> <span class="o">+</span> <span class="n">F_top_pls</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># spectrally-integrated terms:</span>
    <span class="c1"># energy conservation total error</span>
    <span class="n">energy_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_sum</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">energy_error</span> <span class="o">&gt;</span> <span class="mf">1e-10</span><span class="p">:</span>
        <span class="n">energy_conservation_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">energy_sum</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CONSERVATION OF ENERGY ERROR OF </span><span class="si">{</span><span class="n">energy_conservation_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="get_outputs"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.get_outputs">[docs]</a><span class="k">def</span> <span class="nf">get_outputs</span><span class="p">(</span>
    <span class="n">model_config</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="n">illumination</span><span class="p">,</span> <span class="n">F_top_pls</span><span class="p">,</span> <span class="n">F_top_net</span><span class="p">,</span> <span class="n">F_btm_net</span><span class="p">,</span> <span class="n">F_abs</span><span class="p">,</span> <span class="n">L_snw</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assimilates useful data into instance of Outputs class.</span>

<span class="sd">    Args:</span>
<span class="sd">        illumination: instance of Illumination class</span>
<span class="sd">        albedo: ratio of upwwards fluxes and irradiance</span>
<span class="sd">        model_config: instance of ModelConfig class</span>
<span class="sd">        L_snw: mass of ice in each layer</span>
<span class="sd">        F_abs: absorbed flux in each layer</span>
<span class="sd">        F_btm_net: net flux at bottom surface</span>

<span class="sd">    Returns:</span>
<span class="sd">        outputs: instance of Outputs class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intensity_top</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model_config</span><span class="o">.</span><span class="n">nbr_wvl</span><span class="p">)</span>
    <span class="n">abs_vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">)</span>
    <span class="n">abs_nir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">Outputs</span><span class="p">()</span>

    <span class="c1"># surface planar intensity</span>
    <span class="n">intensity_top</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">F_top_pls</span> <span class="o">+</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span> <span class="o">+</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span>
    <span class="p">)</span>

    <span class="c1"># Hemispheric wavelength-dependent albedo</span>
    <span class="n">albedo</span> <span class="o">=</span> <span class="n">F_top_pls</span> <span class="o">/</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span> <span class="o">+</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span>
    <span class="p">)</span>

    <span class="c1"># Net flux at upper model boundary</span>
    <span class="n">F_top_net</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">F_top_pls</span> <span class="o">-</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span> <span class="o">+</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ice</span><span class="o">.</span><span class="n">nbr_lyr</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">abs_vis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">])</span>
        <span class="n">abs_nir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">F_abs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="c1"># Spectrally-integrated absorption in each layer:</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_slr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F_abs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># energy absorbed by underlying substrate</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_slr_btm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">F_btm_net</span><span class="p">))</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_vis_btm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">F_btm_net</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">]))</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_nir_btm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">F_btm_net</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Calculate radiative heating rate in kelvin per second.</span>
    <span class="c1"># Multiply by 3600 to convert to K per hour</span>
    <span class="c1"># specfic heta capacity of ice = 2117 J kg-1 K-1</span>
    <span class="n">heat_rt</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">abs_slr</span> <span class="o">/</span> <span class="p">(</span><span class="n">L_snw</span> <span class="o">*</span> <span class="mi">2117</span><span class="p">)</span>  <span class="c1"># [K / s]</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">heat_rt</span> <span class="o">=</span> <span class="n">heat_rt</span> <span class="o">*</span> <span class="mi">3600</span>  <span class="c1"># [K / hr]</span>

    <span class="c1"># ----------------------------------------------------------------------------------</span>
    <span class="c1"># Re-alias results for outputting</span>
    <span class="c1"># ----------------------------------------------------------------------------------</span>

    <span class="c1"># total incident insolation(Wm - 2)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">total_insolation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">mu_not</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fs</span><span class="p">)</span> <span class="o">+</span> <span class="n">illumination</span><span class="o">.</span><span class="n">Fd</span>
    <span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">albedo</span> <span class="o">=</span> <span class="n">albedo</span>

    <span class="c1"># energy absorbed by all snow layers</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_slr_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F_abs</span><span class="p">))</span>

    <span class="c1"># Spectrally - integrated solar, visible, and NIR albedos:</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">BBA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span> <span class="o">*</span> <span class="n">albedo</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">)</span>

    <span class="n">outputs</span><span class="o">.</span><span class="n">BBAVIS</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">]</span>
        <span class="o">*</span> <span class="n">albedo</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">])</span>

    <span class="n">outputs</span><span class="o">.</span><span class="n">BBANIR</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">]</span>
        <span class="o">*</span> <span class="n">albedo</span><span class="p">[</span><span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">])</span>

    <span class="c1"># % Spectrally - integrated VIS and NIR total snowpack absorption:</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_vis_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">]</span>
        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">albedo</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">abs_nir_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="n">illumination</span><span class="o">.</span><span class="n">flx_slr</span><span class="p">[</span><span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">]</span>
        <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">albedo</span><span class="p">[</span><span class="n">model_config</span><span class="o">.</span><span class="n">vis_max_idx</span> <span class="p">:</span> <span class="n">model_config</span><span class="o">.</span><span class="n">nir_max_idx</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">absorbed_flux_per_layer</span> <span class="o">=</span> <span class="n">F_abs</span>

    <span class="k">return</span> <span class="n">outputs</span></div>


<div class="viewcode-block" id="apply_smoothing_function"><a class="viewcode-back" href="../../src.html#src.toon_rt_solver.apply_smoothing_function">[docs]</a><span class="k">def</span> <span class="nf">apply_smoothing_function</span><span class="p">(</span><span class="n">albedo</span><span class="p">,</span> <span class="n">model_config</span><span class="p">):</span>

    <span class="n">yhat</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">albedo</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span> <span class="n">model_config</span><span class="o">.</span><span class="n">poly_order</span><span class="p">)</span>
    <span class="n">albedo</span> <span class="o">=</span> <span class="n">yhat</span>

    <span class="k">return</span> <span class="n">albedo</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Joseph Cook.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>